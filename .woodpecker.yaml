# NodeJS / 11ty on Woodpecker to codeberg pages
#
# https://cjerrington.codeberg.page/eleventy-base-blog-site/blog/codebergpagesbuild/
#
# This file would typically be .woodpecker.yml in the root of your repository.
#
# Takes a repository with 11ty source, generates the static site and
# pushes the result to codeberg pages
#
#
# SECRETS
# https://woodpecker-ci.org/docs/usage/secrets
# CBTOKEN needs a codeberg access token as secret in woodpecker config
# CBMAIL with email address for git config
# SOURCEREPO must be replaced with the source repo
# DESTREPO must be replaced with the target codeberg pages repo
# CBUSERNAME must be replaced with the user/org
#
#
# We also assume a domains file in the source repo that gets copied to
# .domains in the target repo so codeberg pages works for custom domains
#

when:
  event: [push, pull_request]

variables:
  - &node_image 'docker.io/node:24-alpine'

steps:
  install-dependencies:
    image: *node_image
    directory: soapbox/
    commands:
      - corepack enable
      - pnpm config set store-dir /site/pnpm
      - pnpm install --frozen-lockfile
    volumes:
      - /home/ubuntu/supabase-project/volumes/site:/site

  lint:
    depends_on:
      - install-dependencies
    image: *node_image
    directory: soapbox/
    commands:
      - corepack enable
      - pnpm lint
    volumes:
      - /home/ubuntu/supabase-project/volumes/site:/site
  
  docker-build:
    environment:
      NEXT_PUBLIC_SUPABASE_URL:
        from_secret: supabase_url
      NEXT_PUBLIC_SUPABASE_PUBLISHABLE_KEY:
        from_secret: publishable_key
    depends_on:
      - install-dependencies
      - lint
    image: docker:29.0.0 # fix at least major here
    commands:
      - docker build --build-arg NEXT_PUBLIC_SUPABASE_URL=$${NEXT_PUBLIC_SUPABASE_URL} --build-arg NEXT_PUBLIC_SUPABASE_PUBLISHABLE_KEY=$${NEXT_PUBLIC_SUPABASE_PUBLISHABLE_KEY} -t soapbox soapbox
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
